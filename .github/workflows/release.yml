name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: sqaisar/langfuse-controller
  HELM_CHART_NAME: sqaisar

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: .go-version
          cache: true

      - name: Run tests
        run: make test

  build-images:
    name: Build per-arch images
    needs: test
    runs-on: ${{ matrix.runner }}
    permissions:
      packages: write
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{raw}}

      - name: Build & push per-arch image
        run: |
          TAG="${{ steps.meta.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          docker build \
            --platform=linux/$ARCH \
            -t $REGISTRY/$IMAGE_NAME:$TAG-$ARCH \
            .
          docker push $REGISTRY/$IMAGE_NAME:$TAG-$ARCH

      # FIX: split into 2 steps
      - name: Write tag file
        run: echo "${{ steps.meta.outputs.version }}" > tag.txt

      - name: Upload tag file for manifest job
        uses: actions/upload-artifact@v4
        with:
          name: tag-${{ matrix.arch }}
          path: tag.txt

  manifest:
    name: Create multi-arch manifest
    needs: build-images
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: tag-amd64
          path: amd64

      - uses: actions/download-artifact@v4
        with:
          name: tag-arm64
          path: arm64

      - name: Read version tag
        id: tag
        run: |
          TAG=$(cat amd64/tag.txt)
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create & push manifest
        run: |
          TAG="${{ steps.tag.outputs.TAG }}"

          docker manifest create $REGISTRY/$IMAGE_NAME:$TAG \
            --amend $REGISTRY/$IMAGE_NAME:$TAG-amd64 \
            --amend $REGISTRY/$IMAGE_NAME:$TAG-arm64

          docker manifest push $REGISTRY/$IMAGE_NAME:$TAG

  helm-release:
    name: Helm + GitHub Release
    needs: manifest
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update Helm Chart version
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          sed -i "s/^version:.*/version: ${VERSION}/" charts/langfuse-controller-helm/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${VERSION}\"/" charts/langfuse-controller-helm/Chart.yaml
          sed -i "s/tag:.*/tag: \"${VERSION}\"/" charts/langfuse-controller-helm/values.yaml

      - name: Package Helm chart
        run: helm package charts/langfuse-controller-helm

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to Helm registry and push chart
        run: |
          # Use registry-1.docker.io for Helm (Docker Hub's registry endpoint)
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | \
          helm registry login registry-1.docker.io \
            -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
          
          CHART_VERSION=${{ steps.version.outputs.VERSION }}
          echo "Pushing chart version: ${CHART_VERSION}"
          echo "Chart file: langfuse-controller-helm-${CHART_VERSION}.tgz"
          echo "OCI path: oci://${{ env.REGISTRY }}/${{ env.HELM_CHART_NAME }}"
          
          helm push langfuse-controller-helm-${CHART_VERSION}.tgz \
            oci://${{ env.REGISTRY }}/${{ env.HELM_CHART_NAME }}

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## Docker Image
            ```bash
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
            ```

            ## Helm Chart
            ```bash
            helm install langfuse-controller oci://${{ env.REGISTRY }}/${{ env.HELM_CHART_NAME }}/langfuse-controller-helm --version ${{ steps.version.outputs.VERSION }}
            ```

            ## Changes
            ${{ steps.changelog.outputs.CHANGELOG }}
          files: |
            langfuse-controller-helm-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
